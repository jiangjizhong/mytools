#!/usr/bin/python

import pexpect
import os.path
import ConfigParser
import sys

def ssh(host, user, password):
    child = pexpect.spawn("ssh %s@%s" % (user, host))
    #child.logfile = sys.stdout
    try:
        i = child.expect(["yes/no", "Password", r"#|\$"])
        if i == 0:
            child.sendline("yes")
        elif i == 1:
            if not password:
                print >> stderr, "need password."
                child.terminate()
            child.sendline("%s" % (password))
        child.interact()
    except pexpect.EOF:
        print >> stderr, "Remote close connection."
    except pexpect.TIMEOUT:
        print >> stderr, "Timeout."



if __name__ == "__main__":
    config_file = os.path.expanduser("~/.go");
    config = ConfigParser.ConfigParser({})
    if os.path.exists(config_file):
        config.read(config_file)
    section = sys.argv[1]
    if not config.has_section(section):
        print >> sys.stderr, "There is no config for %s" % section
        sys.exit(1)
    info = dict(config.items(section))
    ssh(info.get("host"), info.get("user"), info.get("password"))
